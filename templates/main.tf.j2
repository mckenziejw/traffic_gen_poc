terraform {
  required_providers {
    lxd = {
      source = "terraform-lxd/lxd"
    }
  }
}

provider "lxd" {
    generate_client_certificates = true
    accept_remote_certificate = true  

    remote {
        name = "lxd_host_1"
        scheme = "https"
        address = "wifi-host"
        port = "8443"
        password = "lab123"
        default = true
    }
}

resource "lxd_network" "wifi1" {
    name = "wifi1"
    remote = "lxd_host_1"
    type = "physical"
    config = {
        "parent" = "{{wifis[0].dev_name}}",
    }
}

resource "lxd_network" "wifi2" {
    name = "wifi2"
    remote = "lxd_host_1"
    type = "physical"
    config = {
        "parent" = "{{wifis[1].dev_name}}"
    }
}

resource "lxd_network" "wifi3" {
    name = "wifi3"
    remote = "lxd_host_1"
    type = "physical"
    config = {
        "parent" = "{{wifis[2].dev_name}}"
    }
}

resource "lxd_network" "wifi4" {
    name = "wifi4"
    remote = "lxd_host_1"
    type = "physical"
    config = {
        "parent" = "{{wifis[3].dev_name}}"
    }
}


resource "lxd_instance" "wifi_client_1" {
    name = "wifi-client-1"
    image = "kali-wifi"
    type = "container"
    remote = "lxd_host_1"
    running = true

    device  {
        name = "wifi1"
        type = "nic"
        properties = {
            "network" = "wifi1"
        }
    }

    device {
        name = "rfkill"
        type = "unix-char"
        properties = {
            "major" = 10
            "minor" = 242
            "path" = "/dev/rfkill"
            "source" = "/dev/rfkill"
        }
    }

    config = {
        "boot.autostart" = true
        "security.privileged" = true
    }

    depends_on = [lxd_network.wifi1, lxd_network.wifi2, lxd_network.wifi3, lxd_network.wifi4]
}

resource "lxd_instance" "wifi_client_2" {
    name = "wifi-client-2"
    image = "kali-wifi"
    type = "container"
    remote = "lxd_host_1"
    running = true

    device  {
        name = "wifi2"
        type = "nic"
        properties = {
            "network" = "wifi2"
        }
    }
    device {
        name = "rfkill"
        type = "unix-char"
        properties = {
            "major" = 10
            "minor" = 242
            "path" = "/dev/rfkill"
            "source" = "/dev/rfkill"
        }
    }

    config = {
        "boot.autostart" = true
        "security.privileged" = true
    }

    depends_on = [lxd_network.wifi1, lxd_network.wifi2, lxd_network.wifi3, lxd_network.wifi4]

}

resource "lxd_instance" "wifi_client_3" {
    name = "wifi-client-3"
    image = "kali-wifi"
    type = "container"
    remote = "lxd_host_1"
    running = true

    device  {
        name = "wifi3"
        type = "nic"
        properties = {
            "network" = "wifi3"
        }
    }
    device {
        name = "rfkill"
        type = "unix-char"
        properties = {
            "major" = 10
            "minor" = 242
            "path" = "/dev/rfkill"
            "source" = "/dev/rfkill"
        }
    }


    config = {
        "boot.autostart" = true
        "security.privileged" = true
    }

    depends_on = [lxd_network.wifi1, lxd_network.wifi2, lxd_network.wifi3, lxd_network.wifi4]

}

resource "lxd_instance" "wifi_client_4" {
    name = "wifi-client-4"
    image = "kali-wifi"
    type = "container"
    remote = "lxd_host_1"
    running = true

    device  {
        name = "wifi4"
        type = "nic"
        properties = {
            "network" = "wifi4"
        }
    }
    device {
        name = "rfkill"
        type = "unix-char"
        properties = {
            "major" = 10
            "minor" = 242
            "path" = "/dev/rfkill"
            "source" = "/dev/rfkill"
        }
    }


    config = {
        "boot.autostart" = true
        "security.privileged" = true
    }

    depends_on = [lxd_network.wifi1, lxd_network.wifi2, lxd_network.wifi3, lxd_network.wifi4]

}